#!/usr/bin/env bash

echo "Installing Node.js via nvm..."

# Detect if we're in a container (no sudo) or regular system
if command -v sudo &>/dev/null; then
    SUDO_CMD="sudo"
else
    SUDO_CMD=""
fi

# Detect package manager
if command -v pacman &>/dev/null; then
    DISTRO="arch"
elif command -v apt &>/dev/null; then
    DISTRO="debian"
else
    echo "Unsupported distribution"
    exit 1
fi

# Install curl if not present (needed for nvm installation)
if ! command -v curl &>/dev/null; then
    echo "Installing curl..."
    case $DISTRO in
        arch)
            $SUDO_CMD pacman -S --noconfirm --needed curl
            ;;
        debian)
            $SUDO_CMD apt update
            DEBIAN_FRONTEND=noninteractive $SUDO_CMD apt install -y curl
            ;;
    esac
fi

# Remove any existing system Node.js installations to avoid conflicts
echo "Removing any existing Node.js installations..."
case $DISTRO in
    arch)
        if pacman -Qi nodejs &>/dev/null; then
            echo "Removing system nodejs from Arch..."
            $SUDO_CMD pacman -R --noconfirm nodejs npm || true
        fi
        ;;
    debian)
        if dpkg -l | grep -q nodejs; then
            echo "Removing system nodejs from Debian/Ubuntu..."
            DEBIAN_FRONTEND=noninteractive $SUDO_CMD apt remove -y nodejs npm || true
            DEBIAN_FRONTEND=noninteractive $SUDO_CMD apt autoremove -y || true
        fi
        ;;
esac

# Clean up old Node.js related directories and configs
echo "Cleaning up old Node.js configurations..."
rm -rf "$HOME/.npm" "$HOME/.local/npm" "$HOME/.local/npm-global" "$HOME/.local/n"
if [ -f "$HOME/.npmrc" ]; then
    echo "Backing up existing .npmrc..."
    mv "$HOME/.npmrc" "$HOME/.npmrc.backup.$(date +%s)"
fi

# Install nvm if not present
if [ ! -d "$HOME/.config/nvm" ]; then
    echo "Installing nvm..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
fi

# Source nvm for this script
export NVM_DIR="$HOME/.config/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Install LTS Node
echo "Installing Node LTS..."
nvm install --lts
nvm use --lts

echo ""
echo "=========================================="
echo "Node.js installation complete!"
echo "=========================================="
echo "Node version: $(node -v)"
echo "npm version: $(npm -v)"
echo ""
echo "Make sure your shell config includes:"
echo 'export NVM_DIR="$HOME/.config/nvm"'
echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"'
