#!/usr/bin/env bash

# Check if we're in a container (no sudo) or regular system
if command -v sudo &>/dev/null; then
    SUDO_CMD="sudo"
else
    SUDO_CMD=""
fi

echo "Installing Node.js and npm..."

# Detect package manager and install Node.js
if command -v pacman &>/dev/null; then
    echo "Installing Node.js from Arch repositories..."
    $SUDO_CMD pacman -S --noconfirm --needed nodejs npm
else
    echo "Installing Node.js via package manager (non-interactive)..."
    curl -fsSL https://deb.nodesource.com/setup_lts.x | $SUDO_CMD bash -
    DEBIAN_FRONTEND=noninteractive $SUDO_CMD apt install -y nodejs
fi

echo "Configuring npm to use user-local directory..."

# Configure npm to install global packages in user's home directory
mkdir -p "$HOME/.local/npm-global"
npm config set prefix "$HOME/.local/npm-global"

# Add to PATH for current session
export PATH="$HOME/.local/npm-global/bin:$PATH"

echo "Installing npm packages globally..."

if command -v npm &>/dev/null; then
    npm install -g npm@latest
    npm install -g yarn
    npm install -g pnpm
    npm install -g n
fi

echo "Setting up latest Node.js with n..."

if command -v n &>/dev/null; then
    # Configure n to use user-local directory
    export N_PREFIX="$HOME/.local/n"
    mkdir -p "$N_PREFIX"
    n latest
fi

echo "Node.js installation complete!"
echo "Make sure your shell config includes: export PATH=\"\$HOME/.local/npm-global/bin:\$PATH\""
node --version
npm --version
