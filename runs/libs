#!/usr/bin/env bash

echo "Installing system libraries and tools..."

# Detect the distribution and package manager
detect_distro() {
    if command -v pacman &>/dev/null; then
        echo "arch"
    elif command -v apt &>/dev/null; then
        echo "debian"
    else
        echo "unknown"
    fi
}

# Check if we're in a container (no sudo) or regular system
if command -v sudo &>/dev/null; then
    SUDO_CMD="sudo"
else
    SUDO_CMD=""
fi

DISTRO=$(detect_distro)
echo "Detected distribution: $DISTRO"

case $DISTRO in
    arch)
        echo "Using pacman package manager..."
        $SUDO_CMD pacman -Sy --noconfirm --needed \
            git \
            ripgrep \
            xclip \
            jq \
            tldr \
            python-pip \
            base-devel
        
        # Arch-specific packages
        $SUDO_CMD pacman -S --noconfirm --needed pavucontrol
        ;;
    
    debian)
        echo "Using apt package manager..."
        $SUDO_CMD apt update
        DEBIAN_FRONTEND=noninteractive $SUDO_CMD apt install -y \
            git \
            ripgrep \
            xclip \
            jq \
            tldr \
            pavucontrol \
            python3-pip \
            build-essential
        ;;
    
    *)
        echo "Unsupported distribution"
        exit 1
        ;;
esac

echo "Installing fzf..."

# Create directory if it doesn't exist
mkdir -p $HOME/personal

# Clone or update fzf repository
if [ -d "$HOME/personal/fzf" ]; then
    echo "fzf already cloned, updating..."
    cd $HOME/personal/fzf
    git pull
    cd -
else
    git clone https://github.com/junegunn/fzf.git $HOME/personal/fzf
fi

# Install fzf non-interactively with all features enabled
$HOME/personal/fzf/install --all --key-bindings --completion --update-rc

echo "Libraries and tools installation complete!"

# Verify installations
echo "Verifying installations:"
git --version 2>/dev/null && echo "✓ git installed" || echo "✗ git failed"
rg --version 2>/dev/null && echo "✓ ripgrep installed" || echo "✗ ripgrep failed"
jq --version 2>/dev/null && echo "✓ jq installed" || echo "✗ jq failed"
$HOME/personal/fzf/bin/fzf --version 2>/dev/null && echo "✓ fzf installed" || echo "✗ fzf failed"
